#!/usr/bin/env sh

exec 2>/dev/null

git pull --rebase || {
    echo "\e[1;31mä»£ç æ‹‰å–å¤±è´¥\e[0m"
    exit 1
}

echo "\e[1;32m\e[1mä»£ç æ‹‰å–æˆåŠŸ\e[0m"

commit-and-tag-version

# è·å–ä»“åº“æ ¹ç›®å½•
repo_root_dir=$(git rev-parse --show-toplevel)

# è·å–æœ€æ–°çš„æ ‡ç­¾
latest_tag_global=$(git describe --tags "$(git rev-list --tags --max-count=1)")

git tag -d "${latest_tag_global}"

updateVersionTag() {
    latest_tag=$(git describe --tags "$(git rev-list --tags --max-count=1)" 2>/dev/null)

    # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ä»æ ‡ç­¾ä¸­æå–ä¸»ç‰ˆæœ¬å·ã€æ¬¡ç‰ˆæœ¬å·å’Œä¿®è®¢å·
    major_version=$(echo "${latest_tag}" | cut -d '.' -f 1 | sed 's/v//')
    minor_version=$(echo "${latest_tag}" | cut -d '.' -f 2)
    patch_version=$(echo "${latest_tag}" | cut -d '.' -f 3)

    # å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æäº¤ï¼Œå³æ²¡æœ‰æ ‡ç­¾
    if [ -z "${latest_tag}" ]; then
        new_tag="v1.0.0"
        echo "${new_tag}"
        return
    fi

    # æ›´æ–°ç‰ˆæœ¬å·é€»è¾‘
    if [ "${patch_version}" -eq 9 ]; then
        # å¦‚æœä¿®è®¢å·ä¸º 9
        patch_version=0 # å°†ä¿®è®¢å·é‡ç½®ä¸º 0

        # æ¥ä¸‹æ¥æ£€æŸ¥æ¬¡ç‰ˆæœ¬å·
        if [ "${minor_version}" -eq 9 ]; then
            # å¦‚æœæ¬¡ç‰ˆæœ¬å·ä¹Ÿä¸º 9
            minor_version=0                      # å°†æ¬¡ç‰ˆæœ¬å·é‡ç½®ä¸º 0
            major_version=$((major_version + 1)) # å°†ä¸»ç‰ˆæœ¬å·åŠ  1
        else
            # å¦‚æœæ¬¡ç‰ˆæœ¬å·ä¸æ˜¯ 9
            minor_version=$((minor_version + 1)) # å°†æ¬¡ç‰ˆæœ¬å·åŠ  1
        fi
    else
        # å¦‚æœä¿®è®¢å·ä¸æ˜¯ 9
        patch_version=$((patch_version + 1)) # å°†ä¿®è®¢å·åŠ  1
    fi

    new_tag="v${major_version}.${minor_version}.${patch_version}"

    # å°†æ–°æ ‡ç­¾è¿”å›
    echo "${new_tag}"
}

updateVersionInPackageJson() {
    new_version="$1"
    sed -i "s/\"version\": \".*\"/\"version\": \"${new_version}\"/" "${repo_root_dir}/package.json"
}

# è°ƒç”¨å‡½æ•°ï¼Œå¹¶å°†ç»“æœèµ‹ç»™å˜é‡
new_tag=$(updateVersionTag)

updateVersionInPackageJson "${new_tag}"
git add "${repo_root_dir}/package.json"
git commit --amend -m "ğŸ”– tag(package.json): ${new_tag}"

# rm "${repo_root_dir}/CHANGELOG.md"
# conventional-changelog -i "${repo_root_dir}/CHANGELOG.md" -s -r 0

# è·å–å½“å‰æœ¬åœ°ä»“åº“çš„è¿œç¨‹URL
remote_url=$(git remote -v | grep origin | grep '(fetch)' | awk '{print $2}')

# æ ¹æ®ä¸åŒè¿œç¨‹ä»“åº“å¤„ç†
case "${remote_url}" in
*github.com*)
    echo "\e[1;32mRemote URL is from GitHub.\e[0m"
    ;;
*gitcode.com*)
    echo "\e[1;32mRemote URL is from GitCode.\e[0m"
    sed -i 's/commits\//commits\/detail\//g' "${repo_root_dir}/CHANGELOG.md"
    ;;
*gitee.com*)
    echo "\e[1;32mRemote URL is from Gitee.\e[0m"
    sed -i 's/commits\//commit\//g' "${repo_root_dir}/CHANGELOG.md"
    ;;
*)
    echo "\e[1;31mRemote URL is from an unknown source.\e[0m"
    ;;
esac

# git add "${repo_root_dir}/CHANGELOG.md"
# git commit -m "ğŸ“ doc(CHANGELOG.md): automatic update"

git tag -a "${new_tag}" -m "ğŸ”– tag: ${new_tag}"
echo "\e[1;32mæ›´æ–°åçš„æ ‡ç­¾ä¸º: ${new_tag}\e[0m"
